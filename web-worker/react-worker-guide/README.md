# React/Vue å·¥ç¨‹åŒ–ä¸­çš„ Web Worker æœ€ä½³å®è·µ

è¿™ä»½æŒ‡å—ä»‹ç»äº†å¦‚ä½•åœ¨ç°ä»£å‰ç«¯å·¥ç¨‹ï¼ˆVite/Webpackï¼‰ä¸­ä¼˜é›…åœ°ä½¿ç”¨ Web Workerã€‚

## ğŸ›  å·¥ç¨‹åŒ–é…ç½®

### 1. æ‰“åŒ…å·¥å…·æ”¯æŒ

åœ¨ç°ä»£æ„å»ºå·¥å…·ä¸­ï¼Œä½¿ç”¨ Worker å·²ç»ä¸éœ€è¦å¤æ‚çš„ loader é…ç½®ï¼Œéµå¾ªæ ‡å‡†è¯­æ³•å³å¯ã€‚

#### Vite (æ¨è)

Vite åŸç”Ÿæ”¯æŒé€šè¿‡ `new URL` å¯¼å…¥ Workerã€‚

```ts
// è‡ªåŠ¨è¯†åˆ«å¹¶æ‰“åŒ… worker.ts
// ?worker åç¼€æ˜¯å¯é€‰çš„ï¼Œä½†åœ¨æŸäº›å¯¼å…¥åœºæ™¯ä¸‹æœ‰ç”¨
const worker = new Worker(
  new URL('./worker.ts', import.meta.url),
  { type: 'module' } // å¯ç”¨æ¨¡å—åŒ–æ”¯æŒ (import/export)
);
```

#### Webpack 5

Webpack 5 ä¹Ÿæ”¯æŒ `new URL` è¯­æ³•ï¼ˆæ— éœ€ `worker-loader`ï¼‰ã€‚

```ts
const worker = new Worker(
  new URL('./worker.ts', import.meta.url)
);
```

### 2. TypeScript ç±»å‹æ”¯æŒ

Worker å†…éƒ¨éœ€è¦æ­£ç¡®çš„ç±»å‹å®šä¹‰ï¼Œé¿å… `self` ç±»å‹æŠ¥é”™ã€‚

åœ¨ `worker.ts` å¤´éƒ¨æ·»åŠ ï¼š

```ts
/// <reference lib="webworker" />
declare const self: DedicatedWorkerGlobalScope;
```

æˆ–è€…åœ¨ `tsconfig.json` ä¸­é…ç½®ï¼š

```json
{
  "compilerOptions": {
    "lib": ["webworker", "ESNext"]
  }
}
```

## ğŸ§© æ¶æ„è®¾è®¡æ¨¡å¼

### 1. å•ä¾‹æ¨¡å¼ vs ä¸´æ—¶å®ä¾‹

| æ¨¡å¼ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **å•ä¾‹ (Singleton)** | å…¨å±€å…±äº«ä¸€ä¸ª Worker å®ä¾‹ | å…¨å±€çŠ¶æ€ç®¡ç†ã€é¢‘ç¹è°ƒç”¨ã€WebSocket é•¿è¿æ¥ |
| **ä¸´æ—¶ (Ephemeral)** | æ¯æ¬¡è°ƒç”¨åˆ›å»ºï¼Œç”¨å®Œå³é”€æ¯ | å¶å°”çš„ä¸€æ¬¡æ€§é‡è®¡ç®—ã€é¿å…å†…å­˜æ³„æ¼ |

**å•ä¾‹å®ç°ç¤ºä¾‹**ï¼š
è§ `useWorker.ts` ä¸­çš„ `WorkerSingleton` ç±»ã€‚

### 2. çŠ¶æ€åŒæ­¥ (State Sync)

ä¸è¦æŠŠ Worker å½“ä½œâ€œå¦ä¸€ä¸ª Storeâ€ï¼Œè€Œåº”æŠŠå®ƒå½“ä½œ**â€œçº¯è®¡ç®—æœåŠ¡â€**æˆ–**â€œè¿œç¨‹å‡½æ•°â€**ã€‚

- **âŒ é”™è¯¯åšæ³•**ï¼šåœ¨ Worker é‡Œç»´æŠ¤å¤æ‚çš„ UI çŠ¶æ€ï¼Œä¸»çº¿ç¨‹é¢‘ç¹æŸ¥è¯¢ã€‚
- **âœ… æ­£ç¡®åšæ³•**ï¼šä¸»çº¿ç¨‹å‘é€æ•°æ® -> Worker è®¡ç®— -> è¿”å›ç»“æœ -> ä¸»çº¿ç¨‹æ›´æ–° React/Vue Stateã€‚

### 3. æ‡’åŠ è½½ (Lazy Loading)

Worker æ–‡ä»¶é€šå¸¸åŒ…å«å¤§é‡è®¡ç®—é€»è¾‘ï¼Œä½“ç§¯è¾ƒå¤§ã€‚å»ºè®®**æŒ‰éœ€åŠ è½½**ã€‚

- ä¸è¦åœ¨æ–‡ä»¶é¡¶å±‚ `new Worker()`ã€‚
- åœ¨ `useEffect` (React) æˆ– `onMounted` (Vue) ä¸­ï¼Œæˆ–è€…åœ¨ç¬¬ä¸€æ¬¡è§¦å‘äº‹ä»¶æ—¶åˆå§‹åŒ–ã€‚

## â“ å¸¸è§è¿½é—® (FAQ)

### Q: SSR (æœåŠ¡ç«¯æ¸²æŸ“) åœºæ™¯èƒ½ç”¨ Worker å—ï¼Ÿ

**A: ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦åšå…¼å®¹å¤„ç†ã€‚**

1. **ç¯å¢ƒå·®å¼‚**ï¼š
    - **æµè§ˆå™¨**ï¼šæœ‰ `window`, `Worker`, `Blob`ã€‚
    - **Node.js (SSR)**ï¼šæ²¡æœ‰ `Worker` å…¨å±€å¯¹è±¡ï¼Œä½†æœ‰ `worker_threads` æ¨¡å—ã€‚

2. **å¤„ç†æ–¹æ¡ˆ**ï¼š
    - **æ¡ä»¶åŠ è½½**ï¼šç¡®ä¿ Worker ä»£ç åªåœ¨å®¢æˆ·ç«¯æ‰§è¡Œã€‚

    ```ts
    if (typeof window !== 'undefined') {
      // åˆå§‹åŒ– Worker
    }
    ```

    - **Next.js / Nuxt**ï¼šé€šå¸¸å°† Worker é€»è¾‘å°è£…åœ¨ `useEffect` æˆ– `onMounted` ä¸­ï¼Œè¿™äº›é’©å­åªåœ¨å®¢æˆ·ç«¯è¿è¡Œã€‚

3. **å¦‚æœæœåŠ¡ç«¯ä¹Ÿéœ€è¦è®¡ç®—**ï¼š
    - éœ€è¦æŠ½è±¡ä¸€å±‚ `ComputationService`ã€‚
    - åœ¨å®¢æˆ·ç«¯ï¼šè°ƒç”¨ Web Workerã€‚
    - åœ¨æœåŠ¡ç«¯ï¼šè°ƒç”¨ Node.js `worker_threads` æˆ–ç›´æ¥åœ¨ä¸»çº¿ç¨‹è®¡ç®—ï¼ˆå¦‚æœå¹¶å‘é‡ä¸å¤§ï¼‰ã€‚

### Q: å¦‚ä½•å¤ç”¨ Worker é‡Œçš„ TypeScript ç±»å‹ï¼Ÿ

**A: æå–å…±äº«ç±»å‹æ–‡ä»¶ã€‚**

åˆ›å»º `types.ts`ï¼š

```ts
export type WorkerPayload = { ... };
export type WorkerResult = { ... };
```

ä¸»çº¿ç¨‹å’Œ Worker çº¿ç¨‹åŒæ—¶ import è¿™ä¸ªæ–‡ä»¶ã€‚ç”±äºæ˜¯çº¯ç±»å‹æ–‡ä»¶ï¼Œç¼–è¯‘åä¼šè¢«æ“¦é™¤ï¼Œä¸ä¼šå¯¼è‡´ Worker ä»£ç è¢«æ‰“åŒ…è¿›ä¸» bundleã€‚

## ğŸ“‚ ç¤ºä¾‹æ–‡ä»¶è¯´æ˜

- `worker.ts`: æ ‡å‡†çš„ TypeScript Module Worker å®ç°ã€‚
- `useWorker.ts`: React Hook å°è£…ï¼Œå®ç°äº†å•ä¾‹ç®¡ç†ã€‚
- `App.tsx`: çº¯ UI ç»„ä»¶ï¼Œå±•ç¤ºå¦‚ä½•æ¶ˆè´¹ Workerã€‚
