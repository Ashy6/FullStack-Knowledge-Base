<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker ä»»åŠ¡ç³»ç»Ÿæ¼”ç¤º</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .task-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #fff; }
        .task-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .progress-bar { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #28a745; width: 0%; transition: width 0.3s; }
        .log-box { height: 200px; overflow-y: auto; background: #333; color: #fff; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #444; }
        .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 10px; background: #eee; }
        .status-running { background: #e3f2fd; color: #0d47a1; }
        .status-completed { background: #e8f5e9; color: #1b5e20; }
        .status-error { background: #ffebee; color: #b71c1c; }
    </style>
</head>
<body>

    <h1>ğŸš€ Worker ä»»åŠ¡ç³»ç»Ÿæ¼”ç¤º</h1>
    <p>æ¼”ç¤ºï¼šRequest ID åŒ¹é…ã€å¯å–æ¶ˆã€è¿›åº¦æ¡ã€è¶…æ—¶æ§åˆ¶</p>

    <div class="card">
        <h3>åˆ›å»ºä»»åŠ¡</h3>
        <div class="btn-group">
            <button onclick="createTask('normal')">âš¡ï¸ æ™®é€šä»»åŠ¡ (3s)</button>
            <button onclick="createTask('long')">ğŸ¢ é•¿ä»»åŠ¡ (10s)</button>
            <button onclick="createTask('timeout')">â± è¶…æ—¶æµ‹è¯• (5s, é™æ—¶2s)</button>
            <button class="danger" onclick="manager.terminate()">â˜ ï¸ é”€æ¯ Worker</button>
            <button onclick="manager.restart()">ğŸ”„ é‡å¯ Worker</button>
        </div>
    </div>

    <div class="card">
        <h3>ä»»åŠ¡åˆ—è¡¨</h3>
        <div id="task-list"></div>
    </div>

    <div class="card">
        <h3>æ—¥å¿—</h3>
        <div id="log-box" class="log-box"></div>
    </div>

    <script src="main.js"></script>
    <script>
        const manager = new WorkerTaskManager('worker.js');
        const taskList = document.getElementById('task-list');
        const logBox = document.getElementById('log-box');

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-line';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function createTask(type) {
            let duration = 3000;
            let timeout = 0;
            let name = "æ™®é€šä»»åŠ¡";

            if (type === 'long') {
                duration = 10000;
                name = "é•¿ä»»åŠ¡";
            } else if (type === 'timeout') {
                duration = 5000;
                timeout = 2000;
                name = "è¶…æ—¶æµ‹è¯•ä»»åŠ¡";
            }

            // 1. åˆ›å»º UI å…ƒç´ 
            const taskEl = document.createElement('div');
            taskEl.className = 'task-item';
            const taskId = 'temp-' + Math.random(); // ä¸´æ—¶çš„ï¼Œç­‰ runTask è¿”å›çœŸæ­£çš„ ID å…¶å®åœ¨å†…éƒ¨ï¼Œè¿™é‡Œæˆ‘ä»¬åªèƒ½æ‹¿ promise
            
            taskEl.innerHTML = `
                <div class="task-header">
                    <span><strong>${name}</strong> (Wait: ${duration/1000}s${timeout ? `, Limit: ${timeout/1000}s` : ''})</span>
                    <div>
                        <span class="status-badge status-running" id="status-${taskId}">è¿è¡Œä¸­</span>
                        <button class="danger" style="padding: 2px 8px; font-size: 12px;" onclick="cancelMyTask('${taskId}')">å–æ¶ˆ</button>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="prog-${taskId}"></div>
                </div>
            `;
            taskList.prepend(taskEl);

            log(`å¼€å§‹ä»»åŠ¡: ${name}`);

            // 2. è¿è¡Œä»»åŠ¡
            const { requestId, result } = manager.runTask({ duration }, {
                timeout,
                onProgress: (p) => {
                    document.getElementById(`prog-${requestId}`).style.width = p + '%';
                }
            });

            // æ›´æ–° UI ID
            taskEl.id = `task-${requestId}`;
            taskEl.innerHTML = `
                <div class="task-header">
                    <span><strong>${name}</strong> (ID: ${requestId})</span>
                    <div>
                        <span class="status-badge status-running" id="status-${requestId}">è¿è¡Œä¸­</span>
                        <button class="danger" style="padding: 2px 8px; font-size: 12px;" onclick="cancelMyTask('${requestId}')">å–æ¶ˆ</button>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="prog-${requestId}"></div>
                </div>
            `;

            // å¤„ç†ç»“æœ
            result.then(res => {
                log(`âœ… ä»»åŠ¡ ${requestId} å®Œæˆ`);
                updateStatus(requestId, 'completed', 'å®Œæˆ');
            }).catch(err => {
                log(`âŒ ä»»åŠ¡ ${requestId} å¤±è´¥: ${err.message}`);
                updateStatus(requestId, 'error', err.message);
            });
        }

        function cancelMyTask(id) {
            manager.cancelTask(id);
        }

        function updateStatus(id, type, text) {
            const badge = document.getElementById(`status-${id}`);
            if (badge) {
                badge.className = `status-badge status-${type}`;
                badge.textContent = text;
            }
        }
    </script>
</body>
</html>
